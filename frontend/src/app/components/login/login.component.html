<p-toast></p-toast>

<div class="flex items-center justify-center min-h-screen p-4 full-container">
  <p-panel class="w-full max-w-md px-8 py-10 shadow-2xl bg-white/95 backdrop-blur-sm rounded-xl">
    <!-- Usuario autenticado -->
    <div *ngIf="currentUser?.id" 
        class="max-w-md p-6 mx-auto ">
      
      <h3 class="mb-2 text-2xl font-bold text-green-600">
        Welcome back, <span class="text-gray-800">{{ currentUser?.username }}</span>!
      </h3>

      <div class="pb-4 mb-4 border-b border-gray-200">
        <p class="flex items-center gap-2 mb-2 text-gray-600">
          <i class="text-green-500 pi pi-envelope"></i>
          {{ currentUser?.email }}
        </p>
        <p class="flex items-center gap-2 text-sm text-gray-500">
          <i class="text-green-500 pi pi-user"></i>
          You are: <span class="capitalize">{{ currentUser?.role }}</span>
        </p>
      </div>

      <p class="mb-6 text-gray-700">
        Manage your account settings below.
      </p>

      <div class="flex flex-col gap-3">
        <p-button 
          label="Change Password" 
          icon="pi pi-key" 
          styleClass="p-button-outlined p-button-success w-full"
          (onClick)="openChangePasswordDialog()">
        </p-button>

        <p-button 
          label="Log Out" 
          icon="pi pi-sign-out" 
          styleClass="p-button-danger w-full"
          (onClick)="handleLogOut()">
        </p-button>
      </div>
    </div>


    <!-- Formulario Login / Registro -->
    <div *ngIf="!currentUser?.id" class="text-center">
      <h3 class="mb-8 text-2xl font-semibold text-green-600">
        {{ isLogin ? 'Welcome back' : 'Create your account' }}
      </h3>

      <!-- Registro -->
      <form *ngIf="!isLogin" [formGroup]="registerForm" (ngSubmit)="handleSignUp()" class="space-y-6">
        <div class="relative text-left">
          <p-floatlabel variant="in" class="w-full">
            <input 
              pInputText 
              id="registerUsername" 
              formControlName="username"
              class="w-full"
              [class.ng-invalid]="registerUsername?.invalid && registerUsername?.touched"
            />
            <label for="registerUsername">
              <i class="pi pi-user"></i> Username
            </label>
          </p-floatlabel>
          <small class="text-xs text-red-500" *ngIf="registerUsername?.invalid && registerUsername?.touched">
            <span *ngIf="registerUsername?.errors?.['required']">Username is required</span>
            <span *ngIf="registerUsername?.errors?.['minlength']">At least 3 characters</span>
            <span *ngIf="registerUsername?.errors?.['maxlength']">Max 50 characters</span>
          </small>
        </div>

        <div class="relative text-left">
          <p-floatlabel variant="in" class="w-full">
            <input 
              pInputText 
              id="registerEmail" 
              formControlName="email"
              class="w-full"
              [class.ng-invalid]="registerEmail?.invalid && registerEmail?.touched"
            />
            <label for="registerEmail">
              <i class="pi pi-envelope"></i> Email
            </label>
          </p-floatlabel>
          <small class="text-xs text-red-500" *ngIf="registerEmail?.invalid && registerEmail?.touched">
            <span *ngIf="registerEmail?.errors?.['required']">Email is required</span>
            <span *ngIf="registerEmail?.errors?.['email']">Please enter a valid email</span>
            <span *ngIf="registerEmail?.errors?.['maxlength']">Max 100 characters</span>
          </small>
        </div>

        <div class="relative text-left">
          <p-floatlabel variant="in" class="w-full">
            <input 
              pInputText 
              type="password" 
              id="registerPassword" 
              formControlName="password"
              class="w-full"
              [class.ng-invalid]="registerPassword?.invalid && registerPassword?.touched"
            />
            <label for="registerPassword">
              <i class="pi pi-lock"></i> Password
            </label>
          </p-floatlabel>
          <small class="text-xs text-red-500" *ngIf="registerPassword?.invalid && registerPassword?.touched">
            <span *ngIf="registerPassword?.errors?.['required']">Password is required</span>
            <span *ngIf="registerPassword?.errors?.['minlength']">At least 6 characters</span>
            <span *ngIf="registerPassword?.errors?.['maxlength']">Max 100 characters</span>
          </small>
        </div>

        <div class="relative text-left">
          <p-floatlabel variant="in" class="w-full">
            <input 
              pInputText 
              type="password" 
              id="registerConfirmPassword" 
              formControlName="confirmPassword"
              class="w-full"
              [class.ng-invalid]="registerConfirmPassword?.invalid && registerConfirmPassword?.touched"
            />
            <label for="registerConfirmPassword">
              <i class="pi pi-lock"></i> Confirm Password
            </label>
          </p-floatlabel>
          <small class="text-xs text-red-500" *ngIf="registerConfirmPassword?.invalid && registerConfirmPassword?.touched">
            <span *ngIf="registerConfirmPassword?.errors?.['required']">Please confirm your password</span>
            <span *ngIf="registerConfirmPassword?.errors?.['passwordMismatch']">Passwords do not match</span>
          </small>
        </div>

        <div class="pt-4">
          <p-button 
            type="submit" 
            [disabled]="registerForm.invalid" 
            label="Sign me Up" 
            class="w-full max-w-xs mx-auto">
          </p-button>
          <button type="button" class="mt-3 text-sm text-blue-600 hover:underline" (click)="switchToSignUp()">
            Already have an account? Log in
          </button>
        </div>
      </form>

      <!-- Login -->
      <form *ngIf="isLogin" [formGroup]="loginForm" (ngSubmit)="handleLogIn()" class="space-y-6">
        <div class="relative text-left">
          <p-floatlabel variant="in" class="w-full">
            <input 
              pInputText 
              id="loginUsername" 
              formControlName="username"
              class="w-full"
              [class.ng-invalid]="loginUsername?.invalid && loginUsername?.touched"
            />
            <label for="loginUsername">
              <i class="pi pi-user"></i> Username
            </label>
          </p-floatlabel>
          <small class="text-xs text-red-500" *ngIf="loginUsername?.invalid && loginUsername?.touched">
            <span *ngIf="loginUsername?.errors?.['required']">Username is required</span>
            <span *ngIf="loginUsername?.errors?.['minlength']">At least 3 characters</span>
          </small>
        </div>

        <div class="relative text-left">
          <p-floatlabel variant="in" class="w-full">
            <input 
              pInputText 
              type="password" 
              id="loginPassword" 
              formControlName="password"
              class="w-full"
              [class.ng-invalid]="loginPassword?.invalid && loginPassword?.touched"
            />
            <label for="loginPassword">
              <i class="pi pi-lock"></i> Password
            </label>
          </p-floatlabel>
          <small class="text-xs text-red-500" *ngIf="loginPassword?.invalid && loginPassword?.touched">
            <span *ngIf="loginPassword?.errors?.['required']">Password is required</span>
            <span *ngIf="loginPassword?.errors?.['minlength']">At least 6 characters</span>
          </small>
        </div>

        <div class="pt-4">
          <p-button 
            type="submit" 
            [disabled]="loginForm.invalid" 
            label="Log In" 
            class="w-full max-w-xs mx-auto">
          </p-button>
          <button type="button" class="mt-3 text-sm text-blue-600 hover:underline" (click)="switchToSignUp()">
            Don't have an account? Sign up
          </button>
        </div>
      </form>
    </div>
  </p-panel>
</div>

<!-- Change Password Dialog -->
<p-dialog 
  header="Change Password" 
  [(visible)]="displayChangePasswordDialog" 
  [modal]="true" 
  [style]="{width: '450px'}"
  [closable]="true"
  (onHide)="closeChangePasswordDialog()">

  <form [formGroup]="changePasswordForm" (ngSubmit)="handleChangePassword()" class="space-y-4">
    <div class="relative text-left">
      <p-floatlabel variant="in" class="w-full">
        <input 
          pInputText 
          type="password" 
          id="newPassword" 
          formControlName="password"
          class="w-full"
          [class.ng-invalid]="newPassword?.invalid && newPassword?.touched"
        />
        <label for="newPassword">
          <i class="pi pi-lock"></i> New Password
        </label>
      </p-floatlabel>
      <small class="text-xs text-red-500" *ngIf="newPassword?.invalid && newPassword?.touched">
        <span *ngIf="newPassword?.errors?.['required']">Password is required</span>
        <span *ngIf="newPassword?.errors?.['minlength']">At least 6 characters</span>
        <span *ngIf="newPassword?.errors?.['maxlength']">Max 100 characters</span>
      </small>
    </div>

    <div class="relative text-left">
      <p-floatlabel variant="in" class="w-full">
        <input 
          pInputText 
          type="password" 
          id="confirmNewPassword" 
          formControlName="confirmPassword"
          class="w-full"
          [class.ng-invalid]="confirmNewPassword?.invalid && confirmNewPassword?.touched"
        />
        <label for="confirmNewPassword">
          <i class="pi pi-lock"></i> Confirm New Password
        </label>
      </p-floatlabel>
      <small class="text-xs text-red-500" *ngIf="confirmNewPassword?.invalid && confirmNewPassword?.touched">
        <span *ngIf="confirmNewPassword?.errors?.['required']">Please confirm your password</span>
        <span *ngIf="confirmNewPassword?.errors?.['passwordMismatch']">Passwords do not match</span>
      </small>
    </div>
  </form>
  
  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <p-button 
        label="Cancel" 
        severity="secondary"
        (onClick)="closeChangePasswordDialog()">
      </p-button>
      <p-button 
        label="Update Password" 
        [disabled]="changePasswordForm.invalid"
        (onClick)="handleChangePassword()">
      </p-button>
    </div>
  </ng-template>
</p-dialog>