<div class="container p-4 mx-auto">
  <!-- Header -->
  <div class="mb-6">
    <h1 class="mb-2 text-3xl font-bold text-gray-800">Product & Category Management</h1>
    <p class="text-gray-600">Manage products and categories for the store</p>
  </div>

  <!-- Categories Section -->
  <p-card class="mb-6 ">
    <ng-template pTemplate="header">
      <div class="flex items-center justify-between pt-4 m-5">
        <div class="flex items-center gap-2">
          <i class="text-lg pi pi-folder"></i>
          <span class="font-semibold">Categories ({{ categories.length }})</span>
        </div>
        <div class="flex gap-2">
          <p-button
            icon="pi pi-refresh"
            severity="secondary"
            (onClick)="loadCategories()"
            [loading]="categoriesLoading"
            pTooltip="Refresh"
            [outlined]="true"
          />
          <p-button
            icon="pi pi-plus"
            label="New Category"
            (onClick)="openNewCategoryDialog()"
          />
        </div>
      </div>
    </ng-template>

    <!-- Loading skeleton for categories -->
    <div *ngIf="categoriesLoading" class="space-y-4">
      <p-skeleton height="3rem" *ngFor="let item of [1,2,3]"></p-skeleton>
    </div>

    <!-- Categories table -->
    <p-table 
      *ngIf="!categoriesLoading"
      [value]="categories"
      [paginator]="true"
      [rows]="5"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} categories"
      [rowsPerPageOptions]="[5,10,20]"
      styleClass="p-datatable-striped"
    >
      <ng-template pTemplate="header">
        <tr>
          <th>Name</th>
          <th>Description</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-category>
        <tr>
          <td>
            <div class="font-medium text-blue-600">{{ category.name }}</div>
          </td>
          <td>
            <div class="max-w-xs truncate" [title]="category.description">
              {{ category.description || 'No description' }}
            </div>
          </td>
          <td>
            <div class="text-sm">{{ formatDate(category.createdAt) }}</div>
          </td>
          <td>
            <div class="flex gap-2">
              <p-button
                icon="pi pi-pencil"
                severity="info"
                size="small"
                (onClick)="editCategory(category)"
                pTooltip="Edit category"
                [outlined]="true"
              />
            </div>
          </td>
        </tr>
      </ng-template>

      <!-- Empty state for categories -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="4" class="py-8 text-center">
            <div class="flex flex-col items-center">
              <i class="mb-4 text-4xl text-gray-400 pi pi-folder"></i>
              <p class="text-lg text-gray-500">No categories yet</p>
              <p class="text-sm text-gray-400">Create your first category to get started</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- Products Section -->
  <p-card>
    <ng-template pTemplate="header">
      <div class="flex items-center justify-between pt-4 m-5">
        <div class="flex items-center gap-2">
          <i class="text-lg pi pi-box"></i>
          <span class="font-semibold">Products ({{ products.length }})</span>
        </div>
        <div class="flex gap-2">
          <p-button
            icon="pi pi-refresh"
            severity="secondary"
            (onClick)="loadProducts()"
            [loading]="productsLoading"
            pTooltip="Refresh"
            [outlined]="true"
          />
          <p-button
            icon="pi pi-plus"
            label="New Product"
            (onClick)="openNewProductDialog()"
            [disabled]="categories.length === 0"
          />
        </div>
      </div>
    </ng-template>

    <!-- Loading skeleton for products -->
    <div *ngIf="productsLoading" class="space-y-4">
      <p-skeleton height="4rem" *ngFor="let item of [1,2,3,4,5]"></p-skeleton>
    </div>

    <!-- Products table -->
    <p-table 
      *ngIf="!productsLoading"
      [value]="products"
      [paginator]="true"
      [rows]="10"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} products"
      [rowsPerPageOptions]="[5,10,20]"
      styleClass="p-datatable-striped"
    >
      <ng-template pTemplate="header">
        <tr>
          <th>Product</th>
          <th>Category</th>
          <th>Price</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-product>
        <tr>
          <td>
            <div class="flex items-center gap-3">
              <div class="flex items-center justify-center w-12 h-12 overflow-hidden bg-gray-100 rounded-lg">
                <img 
                  *ngIf="product.imageUrl" 
                  [src]="product.imageUrl" 
                  [alt]="product.name"
                  class="object-cover w-full h-full"
                  (error)="$any($event.target).style.display='none'"
                />
                <i *ngIf="!product.imageUrl" class="text-gray-400 pi pi-image"></i>
              </div>
              <div>
                <div class="font-medium text-blue-600">{{ product.name }}</div>
                <div class="max-w-xs text-xs text-gray-500 truncate" *ngIf="product.description">
                  {{ product.description }}
                </div>
              </div>
            </div>
          </td>
          <td>
            <p-tag 
              [value]="product.category?.name || 'Unknown'"
              severity="info"
            />
          </td>
          <td>
            <div class="font-semibold text-green-600">
              {{ formatCurrency(product.price) }}
            </div>
          </td>
          <td>
            <div class="text-sm">{{ formatDate(product.createdAt) }}</div>
          </td>
          <td>
            <div class="flex gap-2">
              <p-button
                icon="pi pi-pencil"
                severity="info"
                size="small"
                (onClick)="editProduct(product)"
                pTooltip="Edit product"
                [outlined]="true"
              />
            </div>
          </td>
        </tr>
      </ng-template>

      <!-- Empty state for products -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="py-8 text-center">
            <div class="flex flex-col items-center">
              <i class="mb-4 text-4xl text-gray-400 pi pi-box"></i>
              <p class="text-lg text-gray-500">No products yet</p>
              <p class="text-sm text-gray-400">Create your first product to get started</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<!-- Category Dialog -->
<p-dialog 
  [(visible)]="categoryDialog" 
  [modal]="true" 
  [style]="{width: '450px'}" 
  [header]="editingCategory ? 'Edit Category' : 'New Category'"
  styleClass="p-fluid"
>
  <ng-template pTemplate="content">
    <div class="field">
      <label htmlFor="categoryName">Name *</label>
      <input 
        id="categoryName"
        type="text" 
        pInputText 
        [(ngModel)]="categoryForm.name"
        required 
        autofocus
        placeholder="Enter category name"
        class="w-full"
      />
    </div>
    <div class="field">
      <label htmlFor="categoryDescription">Description</label>
      <textarea 
        id="categoryDescription"
        rows="3" 
        cols="20" 
        pInputText
        [(ngModel)]="categoryForm.description"
        placeholder="Enter category description (optional)"
        class="w-full resize-none"
      ></textarea>
    </div>
  </ng-template>
  <ng-template pTemplate="footer">
    <p-button 
      label="Cancel" 
      icon="pi pi-times" 
      [outlined]="true"
      (onClick)="hideCategoryDialog()"
    />
    <p-button 
      [label]="editingCategory ? 'Update' : 'Save'" 
      icon="pi pi-check" 
      (onClick)="saveCategoryDialog()"
    />
  </ng-template>
</p-dialog>

<!-- Product Dialog -->
<p-dialog 
  [(visible)]="productDialog" 
  [modal]="true" 
  [style]="{width: '600px'}" 
  [header]="editingProduct ? 'Edit Product' : 'New Product'"
  styleClass="p-fluid"
>
  <ng-template pTemplate="content">
    <div class="field">
      <label htmlFor="productCategory">Category *</label>
      <p-select
        id="productCategory"
        [options]="categoryOptions"
        [(ngModel)]="productForm.categoryId"
        placeholder="Select a category"
        class="w-full"
      />
    </div>
    <div class="field">
      <label htmlFor="productName">Name *</label>
      <input 
        id="productName"
        type="text" 
        pInputText 
        [(ngModel)]="productForm.name"
        required 
        placeholder="Enter product name"
        class="w-full"
      />
    </div>
    <div class="field">
      <label htmlFor="productPrice">Price *</label>
      <p-inputNumber
        id="productPrice"
        [(ngModel)]="productForm.price"
        mode="currency"
        currency="COP"
        locale="es-CO"
        [minFractionDigits]="0"
        [maxFractionDigits]="2"
        placeholder="0"
        class="w-full"
      />
    </div>
    <div class="field">
      <label htmlFor="productImageUrl">Image URL</label>
      <input 
        id="productImageUrl"
        type="url" 
        pInputText 
        [(ngModel)]="productForm.imageUrl"
        placeholder="https://example.com/image.jpg"
        class="w-full"
      />
    </div>
    <div class="field">
      <label htmlFor="productDescription">Description</label>
      <textarea 
        id="productDescription"
        rows="3" 
        cols="20" 
        pInputText
        [(ngModel)]="productForm.description"
        placeholder="Enter product description (optional)"
        class="w-full resize-none"
      ></textarea>
    </div>
  </ng-template>
  <ng-template pTemplate="footer">
    <p-button 
      label="Cancel" 
      icon="pi pi-times" 
      [outlined]="true"
      (onClick)="hideProductDialog()"
    />
    <p-button 
      [label]="editingProduct ? 'Update' : 'Save'" 
      icon="pi pi-check" 
      (onClick)="saveProductDialog()"
    />
  </ng-template>
</p-dialog>

<!-- Toast Messages -->
<p-toast />

<!-- Confirmation Dialog -->
<p-confirmDialog />
