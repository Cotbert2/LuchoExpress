<!-- Header -->
<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
  <div>
    <h1 class="text-3xl font-bold text-gray-900">Users Management</h1>
    <p class="text-gray-600 mt-1">Manage users in the system</p>
  </div>
  <p-button 
    label="Create User" 
    icon="pi pi-plus" 
    class="p-button-primary"
    (onClick)="openCreateDialog()">
  </p-button>
</div>

<!-- Filtros -->
<p-card class="mb-6">
  <ng-template pTemplate="header">
    <div class="flex items-center gap-2">
      <i class="pi pi-filter text-lg"></i>
      <span class="font-semibold">Filters</span>
    </div>
  </ng-template>
  
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <!-- Filtro por rol -->
    <div class="flex flex-col">
      <label class="text-sm font-medium text-gray-700 mb-2">Role</label>
      <p-select 
        [(ngModel)]="filters.role" 
        [options]="roleOptions"
        optionLabel="label"
        optionValue="value"
        placeholder="Select role"
        (onChange)="onRoleFilterChange()"
        class="w-full">
      </p-select>
    </div>
    
    <!-- Filtro por email -->
    <div class="flex flex-col">
      <label class="text-sm font-medium text-gray-700 mb-2">Email</label>
      <input 
        pInputText 
        type="text" 
        [(ngModel)]="emailFilter"
        placeholder="Search by email..."
        (input)="onEmailFilterChange()"
        class="w-full">
    </div>
    
    <!-- Botón limpiar filtros -->
    <div class="flex flex-col justify-end">
      <p-button 
        label="Clear Filters"
        icon="pi pi-times" 
        severity="secondary"
        (onClick)="clearFilters()"
        class="w-full">
      </p-button>
    </div>
  </div>
</p-card>

<!-- Tabla de usuarios -->
<p-card>
  <ng-template pTemplate="header">
    <div class="flex items-center gap-2">
      <i class="pi pi-users text-lg"></i>
      <span class="font-semibold">Users ({{ filteredUsers.length }})</span>
    </div>
  </ng-template>
  
  <p-table 
    [value]="filteredUsers" 
    [loading]="loading"
    [paginator]="true" 
    [rows]="10"
    [rowsPerPageOptions]="[5,10,20]"
    styleClass="p-datatable-gridlines"
    [tableStyle]="{'min-width': '50rem'}"
    responsiveLayout="scroll">
    
    <ng-template pTemplate="header">
      <tr>
        <th>User</th>
        <th>Email</th>
        <th>Role</th>
        <th>Status</th>
        <th>Creation Date</th>
        <th>Actions</th>
      </tr>
    </ng-template>
    
    <ng-template pTemplate="body" let-user>
      <tr>
        <td>
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
              <i class="pi pi-user text-blue-600"></i>
            </div>
            <span class="font-medium">{{ user.username }}</span>
          </div>
        </td>
        <td>{{ user.email }}</td>
        <td>
          <p-tag 
            [value]="user.role" 
            [severity]="getRoleSeverity(user.role)">
          </p-tag>
        </td>
        <td>
          <p-tag 
            [value]="getStatusText(user.enabled)" 
            [severity]="getStatusSeverity(user.enabled)">
          </p-tag>
        </td>
        <td>{{ user.createdAt | date:'short' }}</td>
        <td>
          <div class="flex gap-2">
            <p-button 
              icon="pi pi-pencil" 
              severity="info"
              size="small"
              pTooltip="Editar usuario"
              (onClick)="openEditDialog(user)">
            </p-button>
            <p-button 
              *ngIf="canDisableUser(user)"
              icon="pi pi-ban" 
              severity="danger"
              size="small"
              pTooltip="Desactivar usuario"
              (onClick)="confirmDisableUser(user)">
            </p-button>
          </div>
        </td>
      </tr>
    </ng-template>
    
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="6" class="text-center py-8">
          <div class="flex flex-col items-center gap-2">
            <i class="pi pi-users text-4xl text-gray-400"></i>
            <p class="text-gray-500">No se encontraron usuarios</p>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-card>

<!-- Dialog Crear Usuario -->
<p-dialog 
  header="Crear Usuario" 
  [(visible)]="displayCreateDialog" 
  [modal]="true" 
  [style]="{width: '450px'}"
  [closable]="true">
  
  <div class="flex flex-col gap-4">
    <!-- Username -->
    <div class="flex flex-col">
      <label class="text-sm font-medium text-gray-700 mb-2">Nombre de Usuario *</label>
      <input 
        pInputText 
        type="text" 
        [(ngModel)]="createUserForm.username"
        placeholder="Ingrese el nombre de usuario"
        class="w-full">
    </div>
    
    <!-- Email -->
    <div class="flex flex-col">
      <label class="text-sm font-medium text-gray-700 mb-2">Email *</label>
      <input 
        pInputText 
        type="email" 
        [(ngModel)]="createUserForm.email"
        placeholder="Ingrese el email"
        class="w-full">
    </div>
    
    <!-- Password -->
    <div class="flex flex-col">
      <label class="text-sm font-medium text-gray-700 mb-2">Contraseña *</label>
      <p-password 
        [(ngModel)]="createUserForm.password"
        placeholder="Ingrese la contraseña"
        [toggleMask]="true"
        class="w-full">
      </p-password>
    </div>
    
    <!-- Role -->
    <div class="flex flex-col">
      <label class="text-sm font-medium text-gray-700 mb-2">Rol *</label>
      <p-select 
        [(ngModel)]="createUserForm.role" 
        [options]="availableRoleOptions"
        optionLabel="label"
        optionValue="value"
        placeholder="Seleccionar rol"
        class="w-full">
      </p-select>
    </div>
  </div>
  
  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <p-button 
        label="Cancelar" 
        severity="secondary"
        (onClick)="displayCreateDialog = false">
      </p-button>
      <p-button 
        label="Crear Usuario" 
        (onClick)="createUser()">
      </p-button>
    </div>
  </ng-template>
</p-dialog>

<!-- Dialog Editar Usuario -->
<p-dialog 
  header="Editar Usuario" 
  [(visible)]="displayEditDialog" 
  [modal]="true" 
  [style]="{width: '450px'}"
  [closable]="true">
  
  <div class="flex flex-col gap-4" *ngIf="selectedUser">
    <!-- Username -->
    <div class="flex flex-col">
      <label class="text-sm font-medium text-gray-700 mb-2">Nombre de Usuario *</label>
      <input 
        pInputText 
        type="text" 
        [(ngModel)]="editUserForm.username"
        placeholder="Ingrese el nombre de usuario"
        class="w-full">
    </div>
    
    <!-- Email -->
    <div class="flex flex-col">
      <label class="text-sm font-medium text-gray-700 mb-2">Email *</label>
      <input 
        pInputText 
        type="email" 
        [(ngModel)]="editUserForm.email"
        placeholder="Ingrese el email"
        class="w-full">
    </div>
    
    <!-- Role -->
    <div class="flex flex-col">
      <label class="text-sm font-medium text-gray-700 mb-2">Rol *</label>
      <p-select 
        [(ngModel)]="editUserForm.role" 
        [options]="availableRoleOptions"
        optionLabel="label"
        optionValue="value"
        placeholder="Seleccionar rol"
        class="w-full">
      </p-select>
    </div>
    
    <!-- Enabled -->
    <div class="flex items-center gap-2">
      <p-checkbox 
        [(ngModel)]="editUserForm.enabled" 
        [binary]="true"
        inputId="enabled">
      </p-checkbox>
      <label for="enabled" class="text-sm font-medium text-gray-700">Usuario activo</label>
    </div>
  </div>
  
  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <p-button 
        label="Cancelar" 
        severity="secondary"
        (onClick)="displayEditDialog = false">
      </p-button>
      <p-button 
        label="Actualizar Usuario" 
        (onClick)="updateUser()">
      </p-button>
    </div>
  </ng-template>
</p-dialog>

<!-- Toast Messages -->
<p-toast></p-toast>

<!-- Confirm Dialog -->
<p-confirmDialog></p-confirmDialog>
