<div class="container p-4 mx-auto">
  <div class="mb-6">
    <h1 class="mb-2 text-3xl font-bold text-gray-800">My Orders</h1>
    <p class="text-gray-600">Manage and review the status of your orders</p>
  </div>

  <p-card class="mb-6 ">
    <ng-template pTemplate="header">
      <div class="flex items-center gap-2 py-2 pl-5 text-white rounded-t-lg bg-zinc-800">
        <i class="text-lg pi pi-filter"></i>
        <span class="font-semibold">Filters</span>
      </div>
    </ng-template>
    
    <div class="grid grid-cols-1 gap-4 md:grid-cols-4">
      <div class="flex flex-col">
        <label for="search" class="mb-1 text-sm font-medium text-gray-700">Search</label>
        <input
          id="search"
          pInputText
          [(ngModel)]="searchValue"
          placeholder="Order number or address..."
          class="w-full"
          (input)="applyFilters()"
        />
      </div>

      <!-- Date from -->
      <div class="flex flex-col">
        <label for="dateFrom" class="mb-1 text-sm font-medium text-gray-700">From</label>
        <p-datepicker
          [(ngModel)]="dateFrom"
          placeholder="From date"
          dateFormat="dd/mm/yy"
          class="w-full"
          (onSelect)="applyFilters()"
          (onClearClick)="applyFilters()"
        />
      </div>

      <div class="flex flex-col">
        <label for="dateTo" class="mb-1 text-sm font-medium text-gray-700">To</label>
        <p-datepicker
          [(ngModel)]="dateTo"
          placeholder="To date"
          dateFormat="dd/mm/yy"
          class="w-full"
          (onSelect)="applyFilters()"
          (onClearClick)="applyFilters()"
        />
      </div>

      <!-- Clear filters button -->
      <div class="flex flex-col justify-end">
        <p-button
          label="Clear Filters"
          icon="pi pi-times"
          severity="secondary"
          (onClick)="clearFilters()"
          class="w-full"
        />
      </div>
    </div>
  </p-card>

  <p-card>
    <ng-template pTemplate="header">
      <div class="flex items-center justify-between pl-5 text-white rounded-t-lg bg-zinc-800">
        <div class="flex items-center gap-2 py-3">
          <i class="text-lg pi pi-shopping-cart"></i>
          <span class="font-semibold">Orders ({{ filteredOrders.length }})</span>
        </div>
        <p-button
          icon="pi pi-refresh"
          severity="secondary"
          (onClick)="loadOrders()"
          [loading]="loading"
          pTooltip="Refresh"
        />
      </div>
    </ng-template>

    <div *ngIf="loading" class="space-y-4">
      <p-skeleton height="4rem" *ngFor="let item of [1,2,3,4,5]"></p-skeleton>
    </div>

    <p-table 
      *ngIf="!loading"
      [value]="filteredOrders"
      [paginator]="true"
      [rows]="10"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} orders"
      [rowsPerPageOptions]="[5,10,20]"
      styleClass="p-datatable-striped"
    >
      <!-- Order Number Column -->
      <ng-template pTemplate="header">
        <tr>
          <th>Number</th>
          <th>Date</th>
          <th>Status</th>
          <th>Total</th>
          <th>Address</th>
          <th>Products</th>
          <th>Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-order>
        <tr>
          <td>
            <div class="font-medium text-blue-600">{{ order.orderNumber }}</div>
            <div class="text-xs text-gray-500">ID: {{ order.id }}</div>
          </td>

          <td>
            <div class="text-sm">{{ formatDate(order.orderDate) }}</div>
            <div class="text-xs text-gray-500" *ngIf="order.estimatedDeliveryDate">
              Delivery: {{ formatDate(order.estimatedDeliveryDate) }}
            </div>
          </td>

          <td>
            <p-tag 
              [severity]="getStatusSeverity(order.status)"
              [value]="getStatusLabel(order.status)"
              class="text-sm"
            />
          </td>

          <td>
            <div class="font-semibold text-green-600">
              {{ formatCurrency(order.totalAmount) }}
            </div>
          </td>

          <td>
            <div class="max-w-xs truncate" [title]="order.deliveryAddress">
              {{ order.deliveryAddress }}
            </div>
          </td>

          <td>
            <div class="space-y-1">
              <div 
                *ngFor="let product of order.products" 
                class="px-2 py-1 text-sm bg-gray-100 rounded"
              >
                <div class="font-medium">{{ product.productName }}</div>
                <div class="text-xs text-gray-600">
                  Quantity: {{ product.quantity }} | 
                  {{ formatCurrency(product.unitPrice) }} each
                </div>
              </div>
            </div>
          </td>

          <!-- Actions -->
          <td>
            <div class="flex gap-2">
              <!-- Fast tracking button -->
              <p-button
                icon="pi pi-bolt"
                severity="info"
                size="small"
                (onClick)="openTrackingModal(order.orderNumber)"
                pTooltip="Fast Tracking Fetch"
                tooltipPosition="top"
                [outlined]="true"
                class="!text-yellow-500 !border-yellow-500 hover:!bg-yellow-50"
              />

              <!-- Cancel button -->
              <p-button
                *ngIf="canCancelOrder(order.status)"
                [icon]="cancellingOrderId === order.id ? 'pi pi-spin pi-spinner' : 'pi pi-times'"
                severity="danger"
                size="small"
                (onClick)="cancelOrder(order)"
                pTooltip="Cancel this order (Only available for pending orders)"
                tooltipPosition="top"
                [outlined]="true"
                [label]="cancellingOrderId === order.id ? 'Cancelling...' : 'Cancel'"
                [disabled]="cancellingOrderId !== null"
              />

              <!-- Status info for non-cancellable orders -->
              <span 
                *ngIf="!canCancelOrder(order.status)"
                class="flex items-center px-2 py-1 text-xs text-gray-500"
                [pTooltip]="getActionTooltip(order.status)"
                tooltipPosition="top"
              >
                <i class="mr-1 pi pi-info-circle"></i>
                {{ getActionMessage(order.status) }}
              </span>
            </div>
          </td>
        </tr>
      </ng-template>

      <!-- Empty state -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="py-8 text-center">
            <div class="flex flex-col items-center">
              <i class="mb-4 text-4xl text-gray-400 pi pi-shopping-cart"></i>
              <p class="text-lg text-gray-500">You don't have any orders yet</p>
              <p class="text-sm text-gray-400">When you place an order, it will appear here</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<p-toast />

<p-confirmDialog />

<p-dialog 
  [(visible)]="trackingModalVisible"
  [modal]="true"
  [style]="{ width: '600px' }"
  [closable]="true"
  [resizable]="false"
  [draggable]="false"
  (onHide)="closeTrackingModal()"
>
  <ng-template pTemplate="header">
    <div class="flex items-center w-full gap-3">
      <i class="text-2xl text-yellow-500 pi pi-bolt"></i>
      <div class="flex-grow">
        <h3 class="m-0 text-xl font-bold text-gray-800">Fast Tracking Fetch</h3>
        <p class="m-0 text-sm text-gray-600" *ngIf="currentTrackingOrderNumber">
          Order: {{ currentTrackingOrderNumber }}
        </p>
      </div>
      <p-button
        icon="pi pi-refresh"
        label="Refresh"
        severity="secondary"
        size="small"
        (onClick)="reloadTrackingData()"
        [loading]="trackingLoading"
        pTooltip="Force refresh tracking data from server (bypasses cache)"
        [outlined]="true"
      />
    </div>
  </ng-template>

  <div class="min-h-48">
    <div *ngIf="trackingLoading" class="flex flex-col items-center justify-center py-8">
      <i class="mb-4 text-3xl text-blue-500 pi pi-spin pi-spinner"></i>
      <p class="text-gray-600">Fetching tracking information...</p>
    </div>

    <div *ngIf="!trackingLoading && trackingError" class="py-8 text-center">
      <i class="mb-4 text-4xl text-red-500 pi pi-exclamation-triangle" 
         *ngIf="!trackingError.includes('Authentication') && !trackingError.includes('Access denied')"></i>
      <i class="mb-4 text-4xl text-orange-500 pi pi-lock" 
         *ngIf="trackingError.includes('Authentication')"></i>
      <i class="mb-4 text-4xl text-red-600 pi pi-ban" 
         *ngIf="trackingError.includes('Access denied')"></i>
      
      <h4 class="mb-2 text-lg font-semibold text-gray-800">Unable to fetch tracking data</h4>
      <p class="mb-4 text-gray-600">{{ trackingError }}</p>
      
      <div class="flex justify-center gap-2">
        <p-button
          label="Try Again"
          icon="pi pi-refresh"
          severity="secondary"
          (onClick)="reloadTrackingData()"
          [outlined]="true"
        />
        <p-button
          *ngIf="trackingError.includes('Authentication')"
          label="Go to Login"
          icon="pi pi-sign-in"
          severity="info"
          routerLink="/login"
          [outlined]="true"
        />
      </div>
    </div>

    <div *ngIf="!trackingLoading && !trackingError && trackingData" class="space-y-4">
      <!-- Tracking Status Card -->
      <div class="p-4 rounded-lg bg-gray-50">
        <div class="flex items-center justify-between mb-3">
          <h4 class="text-lg font-semibold text-gray-800">Tracking Status</h4>
          <p-tag 
            [severity]="getTrackingStatusSeverity(trackingData.status)"
            [value]="getTrackingStatusLabel(trackingData.status)"
            class="text-sm"
          />
        </div>
        
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div>
            <label class="text-sm font-medium text-gray-600">Order ID</label>
            <p class="font-mono text-sm text-gray-800">{{ trackingData.orderId }}</p>
          </div>
          
          <div>
            <label class="text-sm font-medium text-gray-600">Order Number</label>
            <p class="font-semibold text-gray-800">{{ trackingData.orderNumber }}</p>
          </div>
          
          <div>
            <label class="text-sm font-medium text-gray-600">User ID</label>
            <p class="font-mono text-sm text-gray-800">{{ trackingData.userId }}</p>
          </div>
          
          <div>
            <label class="text-sm font-medium text-gray-600">Last Updated</label>
            <p class="text-gray-800">{{ formatDate(trackingData.updatedAt) }}</p>
          </div>
        </div>
      </div>

      <p-divider />

      <div class="p-4 rounded-lg bg-gray-50">
        <h4 class="flex items-center gap-2 mb-3 text-lg font-semibold text-gray-800">
          <i class="pi pi-code"></i>
          Raw Service Response
        </h4>
        <pre class="p-3 overflow-x-auto font-mono text-sm text-green-400 bg-gray-800 rounded">{{ trackingData | json }}</pre>
      </div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex items-center justify-between w-full">
      <div class="flex items-center gap-2 text-sm text-gray-600">
        <i class="pi pi-clock"></i>
        <span>Response time: <strong>{{ trackingResponseTime }}ms</strong></span>
      </div>
      
      <div class="flex gap-2">
        <p-button
          label="Close"
          severity="secondary"
          (onClick)="closeTrackingModal()"
          [outlined]="true"
        />
      </div>
    </div>
  </ng-template>
</p-dialog>
